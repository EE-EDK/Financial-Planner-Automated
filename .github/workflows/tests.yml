name: Tests

on:
  push:
    branches: [ main, master, 'claude/**' ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run weekly on Sundays at midnight to catch dependency issues
    - cron: '0 0 * * 0'
  workflow_dispatch:  # Allow manual trigger

jobs:
  validate:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.python-version }}-
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Install GUI dependencies if available
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi

    - name: Check Python syntax
      run: |
        python -m py_compile tools/finance.py
        python -m py_compile tools/finance_gui.py
        echo "‚úÖ All Python files have valid syntax"

    - name: Validate finance.py imports
      run: |
        cd tools && python -c "import finance; print('‚úÖ finance.py imports successfully')"

    - name: Check required files exist
      run: |
        test -f tools/config.json && echo "‚úÖ tools/config.json exists" || echo "‚ö†Ô∏è  config.json missing (expected in production)"
        test -f budget_editor.html && echo "‚úÖ budget_editor.html exists" || echo "‚ùå budget_editor.html missing"
        test -f README.md && echo "‚úÖ README.md exists" || echo "‚ùå README.md missing"
        test -f tools/finance_gui.spec && echo "‚úÖ finance_gui.spec exists" || echo "‚ùå spec missing"

    - name: Test finance.py help
      run: |
        python tools/finance.py || true
        echo "‚úÖ finance.py help text works"

  build:
    runs-on: ubuntu-latest
    needs: validate  # Only run if validation passes

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-3.11-${{ hashFiles('**/requirements*.txt') }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi

    - name: Verify project structure
      run: |
        echo "üìÇ Project Structure:"
        ls -la
        echo ""
        echo "‚úÖ Simplified finance structure verified"

  lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Check Python syntax
      run: |
        python -m py_compile tools/finance.py
        python -m py_compile tools/finance_gui.py
        echo "‚úÖ All Python files have valid syntax"

    - name: Check file structure
      run: |
        echo "üìã Checking simplified structure..."
        test -f tools/finance.py && echo "‚úÖ tools/finance.py exists" || echo "‚ùå finance.py missing"
        test -f tools/finance_gui.py && echo "‚úÖ tools/finance_gui.py exists" || echo "‚ùå finance_gui.py missing"
        test -f budget_editor.html && echo "‚úÖ budget_editor.html exists" || echo "‚ùå budget_editor.html missing"
        test -f tools/requirements.txt && echo "‚úÖ requirements.txt exists" || echo "‚ùå requirements.txt missing"
        test -f tools/config.json && echo "‚úÖ tools/config.json exists" || echo "‚ùå config.json missing"
        echo "‚úÖ Lint checks passed"
